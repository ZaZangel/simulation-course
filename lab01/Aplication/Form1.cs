using System;                              // Базовые типы и классы .NET
using System.Collections.Generic;           // Для работы с коллекциями
using System.ComponentModel;                // Для компонентов и лицензирования
using System.Data;                          // Для работы с базами данных
using System.Drawing;                       // Для графики и рисования
using System.Globalization;                  // Для форматирования чисел с учетом культуры
using System.Linq;                          // Для LINQ запросов
using System.Text;                          // Для работы с текстом
using System.Threading.Tasks;                // Для асинхронных операций
using System.Windows.Forms;                  // Для создания оконных приложений
using static System.Windows.Forms.VisualStyles.VisualStyleElement; // Для визуальных стилей

namespace Lab_1  // Пространство имен для организации кода
{
    // Частичный класс Form1 (разделен на два файла: код и дизайнер)
    public partial class Form1 : Form
    {
        // Конструктор формы - вызывается при создании окна
        public Form1()
        {
            InitializeComponent(); // Инициализация всех элементов на форме
        }

        // Физические константы (const означает, что значения нельзя изменить)
        const decimal g = 9.81M;        // Ускорение свободного падения (м/с²)
        const decimal C = 0.15M;         // Коэффициент аэродинамического сопротивления
        const decimal rho = 1.29M;        // Плотность воздуха (кг/м³)

        // Переменные для расчета
        decimal dt;    // Шаг по времени (с) - как часто пересчитываем координаты
        decimal x1;     // Максимальная высота полета (для вывода результата)
        int line = -1;  // Номер текущей линии графика (от 0 до 5)

        // Переменные для хранения состояния полета
        decimal t;      // Текущее время полета (с)
        decimal x;      // Текущая координата X (дальность) (м)
        decimal y;      // Текущая координата Y (высота) (м)
        decimal v0;     // Начальная скорость (м/с)
        decimal cosa;   // Косинус угла броска (горизонтальная составляющая)
        decimal sina;   // Синус угла броска (вертикальная составляющая)
        decimal S;      // Площадь поперечного сечения (м²)
        decimal m;      // Масса тела (кг)
        decimal k;      // Коэффициент сопротивления (рассчитывается по формуле)
        decimal vx;     // Горизонтальная составляющая скорости (м/с)
        decimal vy;     // Вертикальная составляющая скорости (м/с)

        // Обработчик клика по графику (не используется, но обязателен)
        private void chart1_Click(object sender, EventArgs e)
        {
            // Метод пустой, так как функционал не требуется
        }

        // Обработчик загрузки формы - выполняется при открытии окна
        private void Form1_Load(object sender, EventArgs e)
        {
            // Устанавливаем шаг по времени по умолчанию
            Step.SelectedItem = "0.1"; // Значение в выпадающем списке
        }

        // Обработчик нажатия кнопки "Старт"
        private void button1_Click(object sender, EventArgs e)
        {
            // Переключаемся на следующую линию для новой траектории
            line++;

            // Если достигли 6-й линии (нумерация с 0), начинаем сначала
            if (line == 6)
            {
                line = 0;
            }

            // Очищаем предыдущие точки на текущей линии графика
            chart1.Series[line].Points.Clear();

            // Запускаем расчет только если таймер не работает
            if (!timer1.Enabled)
            {
                // Считываем начальные параметры с формы
                t = 0;                           // Время = 0
                x = 0;                            // Начальная координата X = 0
                y = Height.Value;                  // Начальная высота (с NumericUpDown)
                v0 = Speed.Value;                   // Начальная скорость (с NumericUpDown)

                // Преобразуем выбранный шаг в число с плавающей точкой
                // CultureInfo.InvariantCulture гарантирует, что разделитель - точка
                dt = Convert.ToDecimal(Step.SelectedItem, CultureInfo.InvariantCulture);

                // Переводим угол из градусов в радианы для Math функций
                double a = (double)Angle.Value * Math.PI / 180;
                // Вычисляем синус и косинус угла
                cosa = (decimal)Math.Cos(a);      // Горизонтальная составляющая
                sina = (decimal)Math.Sin(a);       // Вертикальная составляющая

                // Считываем остальные параметры
                S = Size.Value;                     // Площадь сечения (с NumericUpDown)
                m = Weight.Value;                    // Масса (с NumericUpDown)

                // Рассчитываем коэффициент сопротивления среды
                // Формула: k = 0.5 * C * ρ * S / m
                k = 0.5M * C * rho * S / m;

                // Рассчитываем начальные проекции скорости
                vx = v0 * cosa;     // Начальная горизонтальная скорость
                vy = v0 * sina;     // Начальная вертикальная скорость

                // Добавляем начальную точку на график
                chart1.Series[line].Points.AddXY(x, y);

                // Запускаем таймер для пошагового расчета
                timer1.Start();
            }

            // Обнуляем максимальную высоту для нового расчета
            x1 = 0;
        }

        // Обработчик тика таймера - выполняется каждые dt секунд
        private void timer1_Tick(object sender, EventArgs e)
        {
            // Увеличиваем текущее время на шаг dt
            t += dt;

            // Вычисляем модуль скорости (векторную величину) по теореме Пифагора
            decimal v = (decimal)Math.Sqrt((double)(vx * vx + vy * vy));

            // Обновляем горизонтальную скорость с учетом сопротивления воздуха
            // Сопротивление пропорционально скорости: -k * v * dt
            vx = vx - k * vx * v * dt;

            // Обновляем вертикальную скорость с учетом гравитации и сопротивления
            // Гравитация всегда направлена вниз (-g), сопротивление зависит от скорости
            vy = vy - (g + k * vy * v) * dt;

            // Обновляем координаты (путь = скорость * время)
            x = x + vx * dt;  // Новая координата X
            y = y + vy * dt;  // Новая координата Y

            // Добавляем новую точку на график
            chart1.Series[line].Points.AddXY(x, y);

            // Запоминаем максимальную высоту полета
            if (x1 < y)
            {
                x1 = y; // Обновляем максимум
            }

            // Проверяем, достигло ли тело земли (y <= 0)
            if (y <= 0)
            {
                // Останавливаем таймер - расчет закончен
                timer1.Stop();

                // Выводим результаты с округлением до 3 знаков
                DistanceLabel.Text = "" + Math.Round(x, 3);      // Дальность полета
                StepLabel.Text = "" + dt;                         // Шаг времени
                MaxHeightLabel.Text = "" + Math.Round(x1, 3);     // Максимальная высота
                FinalSpeedLabel.Text = "" + Math.Round(v, 3);     // Скорость в момент падения
            }
        }

        private void label5_Click(object sender, EventArgs e)
        {

        }

        private void panel1_Paint(object sender, PaintEventArgs e)
        {

        }
    }
}